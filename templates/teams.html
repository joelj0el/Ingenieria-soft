{% extends 'base.html' %}

{% block title %}Equipos - OLIMPAZ{% endblock %}

{% block body_class %} class="admin-page"{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/teams.css">
<div class="teams-container">
    {% csrf_token %}
    <div class="teams-header">
        <h1 class="teams-title">Equipos OLIMPAZ</h1>        {% if is_admin %}
        <div class="teams-actions">
            <button id="addDisciplinaBtn" class="btn btn-success me-2">
                <i class="fas fa-plus-circle"></i> Nueva Disciplina
            </button>
            <button id="deleteDisciplinaBtn" class="btn btn-danger me-2">
                <i class="fas fa-trash-alt"></i> Eliminar Disciplina
            </button>
            <button id="addTeamBtn" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Nuevo Equipo
            </button>
        </div>
        {% endif %}
    </div>

    <div class="tabs-container mt-4">
        <ul class="nav nav-tabs" id="teamsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-teams-tab" data-bs-toggle="tab" data-bs-target="#all-teams-content" type="button" role="tab" aria-controls="all-teams-content" aria-selected="true">
                    <i class="fas fa-users"></i> Todos los equipos
                </button>
            </li>
            {% for disciplina in disciplinas %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="disciplina-{{ disciplina.id }}-tab" data-bs-toggle="tab" data-bs-target="#disciplina-{{ disciplina.id }}-content" type="button" role="tab" aria-controls="disciplina-{{ disciplina.id }}-content" aria-selected="false">
                    {{ disciplina.nombre }}
                </button>
            </li>
            {% endfor %}
        </ul>

        <div class="tab-content mt-3" id="teamsTabsContent">
            <!-- Tab Todos los equipos -->
            <div class="tab-pane fade show active" id="all-teams-content" role="tabpanel" aria-labelledby="all-teams-tab">
                <div class="row" id="teamsContainer">
                    <!-- Los equipos se cargarán aquí dinámicamente -->
                </div>
                <div id="teamsMessage" class="text-center py-4"></div>
            </div>

            <!-- Tabs para cada disciplina -->
            {% for disciplina in disciplinas %}
            <div class="tab-pane fade" id="disciplina-{{ disciplina.id }}-content" role="tabpanel" aria-labelledby="disciplina-{{ disciplina.id }}-tab">
                <div class="row" id="disciplina-{{ disciplina.id }}-container">
                    <!-- Los equipos de esta disciplina se cargarán aquí -->
                </div>
                <div id="disciplina-{{ disciplina.id }}-message" class="text-center py-4"></div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal para ver detalles del equipo -->
<div class="modal fade" id="teamDetailsModal" tabindex="-1" aria-labelledby="teamDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content dark-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="teamDetailsModalLabel">Detalles del Equipo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <img id="teamLogoDetail" src="" alt="Logo del equipo" class="img-fluid team-logo-detail">
                    </div>                    <div class="col-md-8">
                        <h3 id="teamNameDetail"></h3>
                        <p><strong>Carrera:</strong> <span id="teamCarreraDetail"></span></p>
                        <p><strong>Disciplina:</strong> <span id="teamDisciplinaDetail"></span></p>
                        <p><strong>Categoría:</strong> <span id="teamCategoriaDetail"></span></p>
                        <p><strong>Capitán:</strong> <span id="teamCapitanDetail"></span></p>
                        <p><strong>Descripción:</strong> <span id="teamDescripcionDetail"></span></p>
                        <p><strong>Fecha de Registro:</strong> <span id="teamFechaDetail"></span></p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4>Jugadores</h4>
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Carrera</th>
                            </tr>
                        </thead>
                        <tbody id="teamJugadoresDetail">
                            <!-- Los jugadores se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                {% if is_admin %}
                <button type="button" class="btn btn-info" id="editTeamBtn">Editar equipo</button>
                <button type="button" class="btn btn-danger" id="deleteTeamBtn">Eliminar equipo</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% if is_admin %}
<!-- Modal para agregar/editar equipo -->
<div class="modal fade" id="addEditTeamModal" tabindex="-1" aria-labelledby="addEditTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content dark-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="addEditTeamModalLabel">Nuevo Equipo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>            <div class="modal-body">
                <form id="addEditTeamForm" enctype="multipart/form-data">
                    <input type="hidden" id="editTeamId" name="editTeamId">
                    
                    <div class="mb-3">
                        <label for="teamName" class="form-label">Nombre del Equipo</label>
                        <input type="text" class="form-control" id="teamName" name="nombre" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">                            <div class="mb-3">
                                <label for="teamCarrera" class="form-label">Carrera del Equipo</label>
                                <select class="form-select" id="teamCarrera" name="carrera_id" required>
                                    <option value="">Seleccionar carrera</option>
                                    <!-- Las carreras se cargarán dinámicamente -->
                                </select>
                                <small class="text-muted">La carrera del equipo es solo para identificación. Los jugadores pueden ser de cualquier carrera.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="teamDisciplina" class="form-label">Disciplina</label>
                                <select class="form-select" id="teamDisciplina" name="disciplina_id" required>
                                    <option value="">Seleccionar disciplina</option>
                                    <!-- Las disciplinas se cargarán dinámicamente -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="teamCategoria" class="form-label">Categoría</label>
                        <select class="form-select" id="teamCategoria" name="categoria" required>
                            <option value="">Seleccionar categoría</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                            <option value="mixto">Mixto</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="teamCapitan" class="form-label">Capitán</label>
                        <select class="form-select" id="teamCapitan" name="capitan_id">
                            <option value="">Seleccionar capitán</option>
                            <!-- Los capitanes se cargarán dinámicamente -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="teamDescripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="teamDescripcion" name="descripcion" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="teamLogo" class="form-label">Logo del Equipo</label>
                        <input type="file" class="form-control" id="teamLogo" name="logo" accept="image/*">
                        <div id="teamLogoPreview" class="mt-2 d-none">
                            <img id="logoPreviewImage" src="" alt="Vista previa del logo" class="img-fluid" style="max-height: 100px;">
                        </div>
                    </div>
                      <div class="mb-3">
                        <label for="jugadoresBuscador" class="form-label">Buscar Jugadores</label>
                        <small class="text-muted d-block mb-2">
                            <i class="fas fa-info-circle"></i> 
                            Cualquier usuario puede participar independientemente de su carrera o rol. 
                            Solo no se puede estar en dos equipos de la misma disciplina.
                        </small>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="jugadoresBuscador" placeholder="Buscar por nombre, usuario o email...">
                            <button class="btn btn-outline-secondary" type="button" id="buscarJugadoresBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="jugadoresResultados" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <!-- Los resultados de búsqueda aparecerán aquí -->
                        </div>
                        <div id="jugadoresSeleccionados" class="mt-2">
                            <h6>Jugadores Seleccionados:</h6>
                            <div id="listaJugadoresSeleccionados">
                                <!-- Los jugadores seleccionados aparecerán aquí -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="saveTeamBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar disciplina -->
<div class="modal fade" id="addEditDisciplinaModal" tabindex="-1" aria-labelledby="addEditDisciplinaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content dark-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="addEditDisciplinaModalLabel">Nueva Disciplina</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEditDisciplinaForm" enctype="multipart/form-data">
                    <input type="hidden" id="editDisciplinaId" name="editDisciplinaId">
                    
                    <div class="mb-3">
                        <label for="disciplinaNombre" class="form-label">Nombre de la Disciplina</label>
                        <input type="text" class="form-control" id="disciplinaNombre" name="nombre" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="disciplinaDescripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="disciplinaDescripcion" name="descripcion" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="disciplinaImagen" class="form-label">Imagen de la Disciplina</label>
                        <input type="file" class="form-control" id="disciplinaImagen" name="imagen" accept="image/*">
                        <div id="disciplinaImagenPreview" class="mt-2 d-none">
                            <img id="imagenPreviewImage" src="" alt="Vista previa de la imagen" class="img-fluid" style="max-height: 100px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="saveDisciplinaBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para eliminar equipo -->
<div class="modal fade" id="deleteTeamModal" tabindex="-1" aria-labelledby="deleteTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content dark-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTeamModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar el equipo <span id="deleteTeamName" class="fw-bold"></span>?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
                
                <div class="mb-3">
                    <label for="confirmTeamPassword" class="form-label">Ingresa tu contraseña para confirmar:</label>
                    <input type="password" class="form-control" id="confirmTeamPassword">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTeamBtn">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para eliminar disciplina -->
<div class="modal fade" id="deleteDisciplinaModal" tabindex="-1" aria-labelledby="deleteDisciplinaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content dark-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDisciplinaModalLabel">Eliminar Disciplina</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="selectDisciplinaStep">
                    <p>Selecciona la disciplina que deseas eliminar:</p>
                    <div class="mb-3">
                        <select class="form-select" id="disciplinaAEliminar">
                            <option value="" disabled selected>Seleccionar disciplina...</option>
                        </select>
                    </div>
                </div>
                
                <div id="confirmDisciplinaStep" style="display: none;">
                    <p>¿Estás seguro de que deseas eliminar la disciplina <span id="deleteDisciplinaName" class="fw-bold"></span>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Advertencia:</strong> Esta acción eliminará:
                        <ul class="mb-0 mt-2">
                            <li>La disciplina seleccionada</li>
                            <li>Todos los equipos registrados en esta disciplina</li>
                            <li>Todos los partidos asociados a esta disciplina</li>
                        </ul>
                    </div>
                    <p class="text-danger"><strong>Esta acción no se puede deshacer.</strong></p>
                    
                    <div class="mb-3">
                        <label for="confirmDisciplinaPassword" class="form-label">Ingresa tu contraseña para confirmar:</label>
                        <input type="password" class="form-control" id="confirmDisciplinaPassword">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="nextStepBtn" style="display: none;">Continuar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteDisciplinaBtn" style="display: none;">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    let currentEditingTeamId = null;
    let currentEditingDisciplinaId = null;
    let currentDeletingTeamId = null;
    let currentDeletingDisciplinaId = null;
    
    // Cargar todas las disciplinas
    function cargarDisciplinas() {
        fetch('/usuarios/api/disciplinas/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar disciplinas: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Llenar select de disciplinas para el formulario de equipos
                const selectDisciplina = document.getElementById('teamDisciplina');
                if (selectDisciplina) {
                    selectDisciplina.innerHTML = '';
                    data.forEach(disciplina => {
                        const option = document.createElement('option');
                        option.value = disciplina.id;
                        option.textContent = disciplina.nombre;
                        selectDisciplina.appendChild(option);
                    });
                }
                
                // Generar tabs dinámicos para disciplinas
                const teamsTabsList = document.getElementById('teamsTabs');
                const teamsTabsContent = document.getElementById('teamsTabsContent');
                
                if (teamsTabsList && teamsTabsContent) {
                    // Mantener el tab "Todos los equipos"
                    const allTeamsTab = teamsTabsList.querySelector('li:first-child');
                    teamsTabsList.innerHTML = '';
                    teamsTabsList.appendChild(allTeamsTab);
                    
                    // Mantener el contenido de "Todos los equipos"
                    const allTeamsContent = teamsTabsContent.querySelector('div:first-child');
                    teamsTabsContent.innerHTML = '';
                    teamsTabsContent.appendChild(allTeamsContent);
                    
                    // Crear tabs para cada disciplina
                    data.forEach(disciplina => {
                        // Crear tab
                        const tabLi = document.createElement('li');
                        tabLi.className = 'nav-item';
                        tabLi.setAttribute('role', 'presentation');
                        tabLi.innerHTML = `
                            <button class="nav-link" id="disciplina-${disciplina.id}-tab" data-bs-toggle="tab"
                                    data-bs-target="#disciplina-${disciplina.id}-content" type="button" role="tab"
                                    aria-controls="disciplina-${disciplina.id}-content" aria-selected="false">
                                ${disciplina.nombre}
                            </button>
                        `;
                        teamsTabsList.appendChild(tabLi);
                        
                        // Crear contenido del tab
                        const tabContent = document.createElement('div');
                        tabContent.className = 'tab-pane fade';
                        tabContent.id = `disciplina-${disciplina.id}-content`;
                        tabContent.setAttribute('role', 'tabpanel');
                        tabContent.setAttribute('aria-labelledby', `disciplina-${disciplina.id}-tab`);
                        tabContent.innerHTML = `
                            <div class="row" id="disciplina-${disciplina.id}-container">
                                <!-- Los equipos se cargarán aquí -->
                            </div>
                            <div id="disciplina-${disciplina.id}-message" class="text-center py-4"></div>
                        `;
                        teamsTabsContent.appendChild(tabContent);
                    });
                }
            })
            .catch(error => {
                console.error('Error al cargar disciplinas:', error);
                document.getElementById('teamsMessage').innerHTML = `<div class="alert alert-danger">Error al cargar disciplinas: ${error.message}</div>`;
            });
    }
    
    // Cargar todas las carreras
    function cargarCarreras() {
        fetch('/usuarios/api/carreras/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar carreras: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const selectCarrera = document.getElementById('teamCarrera');
                if (selectCarrera) {
                    selectCarrera.innerHTML = '<option value="">Seleccionar carrera</option>';
                    data.forEach(carrera => {
                        const option = document.createElement('option');
                        option.value = carrera.id;
                        option.textContent = carrera.nombre;
                        selectCarrera.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error al cargar carreras:', error);
            });
    }
    
    // Cargar todos los equipos
    function cargarEquipos() {
        const teamsContainer = document.getElementById('teamsContainer');
        if (teamsContainer) {
            teamsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
        }
        
        document.getElementById('teamsMessage').innerHTML = '';
        
        // Limpiar todos los contenedores de disciplinas antes de cargar
        document.querySelectorAll('[id^="disciplina-"][id$="-container"]').forEach(container => {
            container.innerHTML = '';
        });
        
        fetch('/usuarios/api/equipos/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar equipos: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (teamsContainer) {
                    teamsContainer.innerHTML = '';
                }
                
                if (data.length === 0) {
                    document.getElementById('teamsMessage').innerHTML = '<p class="lead">No hay equipos registrados aún.</p>';
                    // También mostrar mensaje en cada pestaña de disciplina
                    document.querySelectorAll('[id^="disciplina-"][id$="-message"]').forEach(message => {
                        message.innerHTML = '<p class="lead">No hay equipos registrados en esta disciplina.</p>';
                    });
                    return;
                }
                
                document.getElementById('teamsMessage').innerHTML = '';
                
                // Crear un objeto para agrupar equipos por disciplina
                const equiposPorDisciplina = {};
                
                // Crear tarjetas para cada equipo
                data.forEach(equipo => {
                    // Añadir a la pestaña "Todos los equipos"
                    const card = document.createElement('div');
                    card.className = 'col-md-4 mb-4';
                    card.innerHTML = `
                        <div class="card team-card">
                            <div class="card-header text-center">
                                <h5 class="card-title">${equipo.nombre}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${equipo.disciplina.nombre}</h6>
                            </div>
                            <div class="card-body text-center">
                                <img src="${equipo.logo || '/static/images/default-team.svg'}" alt="${equipo.nombre}" class="img-fluid team-logo">
                                <p class="card-text mt-2">${equipo.descripcion || 'Sin descripción'}</p>
                                <button class="btn btn-info ver-equipo" data-id="${equipo.id}">Ver detalles</button>
                            </div>
                        </div>
                    `;
                    teamsContainer.appendChild(card);
                    
                    // Agregar evento al botón
                    const btnVerEquipo = card.querySelector('.ver-equipo');
                    btnVerEquipo.addEventListener('click', function() {
                        mostrarDetallesEquipo(equipo.id);
                    });
                    
                    // Agrupar por disciplina para añadirlo a su respectiva pestaña
                    if (!equiposPorDisciplina[equipo.disciplina.id]) {
                        equiposPorDisciplina[equipo.disciplina.id] = [];
                    }
                    equiposPorDisciplina[equipo.disciplina.id].push(equipo);
                });
                
                // Ahora añadir los equipos a las pestañas por disciplina
                for (const disciplinaId in equiposPorDisciplina) {
                    const disciplinaContainer = document.getElementById(`disciplina-${disciplinaId}-container`);
                    const disciplinaMessage = document.getElementById(`disciplina-${disciplinaId}-message`);
                    
                    if (disciplinaContainer) {
                        disciplinaContainer.innerHTML = ''; // Limpiar el contenedor
                        
                        equiposPorDisciplina[disciplinaId].forEach(equipo => {
                            const card = document.createElement('div');
                            card.className = 'col-md-4 mb-4';
                            card.innerHTML = `
                                <div class="card team-card">
                                    <div class="card-header text-center">
                                        <h5 class="card-title">${equipo.nombre}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted">${equipo.disciplina.nombre}</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <img src="${equipo.logo || '/static/images/default-team.svg'}" alt="${equipo.nombre}" class="img-fluid team-logo">
                                        <p class="card-text mt-2">${equipo.descripcion || 'Sin descripción'}</p>
                                        <button class="btn btn-info ver-equipo" data-id="${equipo.id}">Ver detalles</button>
                                    </div>
                                </div>
                            `;
                            disciplinaContainer.appendChild(card);
                            
                            // Agregar evento al botón
                            const btnVerEquipo = card.querySelector('.ver-equipo');
                            btnVerEquipo.addEventListener('click', function() {
                                mostrarDetallesEquipo(equipo.id);
                            });
                        });
                        
                        if (disciplinaMessage) {
                            disciplinaMessage.innerHTML = ''; // Limpiar mensaje de carga
                        }
                    }
                }
                
                // Mostrar mensaje para disciplinas sin equipos
                document.querySelectorAll('[id^="disciplina-"][id$="-container"]').forEach(container => {
                    if (container.innerHTML === '') {
                        const disciplinaId = container.id.match(/disciplina-(\d+)-container/)[1];
                        const messageContainer = document.getElementById(`disciplina-${disciplinaId}-message`);
                        if (messageContainer) {
                            messageContainer.innerHTML = '<p class="lead">No hay equipos registrados en esta disciplina.</p>';
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error al cargar equipos:', error);
                document.getElementById('teamsMessage').innerHTML = `<div class="alert alert-danger">Error al cargar equipos: ${error.message}</div>`;
            });
    }
    
    // Mostrar detalles de un equipo
    function mostrarDetallesEquipo(equipoId) {
        const teamDetailsModal = new bootstrap.Modal(document.getElementById('teamDetailsModal'));
        
        fetch(`/usuarios/api/equipos/${equipoId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar detalles del equipo: ' + response.status);
                }
                return response.json();
            })            .then(equipo => {
                document.getElementById('teamNameDetail').textContent = equipo.nombre;
                document.getElementById('teamCarreraDetail').textContent = equipo.carrera ? equipo.carrera.nombre : 'No especificada';
                document.getElementById('teamDisciplinaDetail').textContent = equipo.disciplina.nombre;
                document.getElementById('teamCategoriaDetail').textContent = equipo.categoria || 'No especificada';
                document.getElementById('teamCapitanDetail').textContent = equipo.capitan ? equipo.capitan.nombre : 'No asignado';
                document.getElementById('teamDescripcionDetail').textContent = equipo.descripcion || 'Sin descripción';
                document.getElementById('teamFechaDetail').textContent = equipo.fecha_registro;
                
                const logoImg = document.getElementById('teamLogoDetail');
                logoImg.src = equipo.logo || '/static/images/default-team.svg';
                logoImg.alt = equipo.nombre;
                
                // Guardar ID para la eliminación
                currentDeletingTeamId = equipoId;
                if (document.getElementById('deleteTeamName')) {
                    document.getElementById('deleteTeamName').textContent = equipo.nombre;
                }
                
                const jugadoresTable = document.getElementById('teamJugadoresDetail');
                jugadoresTable.innerHTML = '';
                
                if (equipo.jugadores && equipo.jugadores.length > 0) {
                    equipo.jugadores.forEach(jugador => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${jugador.nombre || 'Sin nombre'}</td>
                            <td>${jugador.email || 'Sin email'}</td>
                            <td>${jugador.carrera || 'No especificada'}</td>
                        `;
                        jugadoresTable.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="3" class="text-center">No hay jugadores registrados</td>';
                    jugadoresTable.appendChild(tr);
                }
                
                // Si existe el botón de editar, configurarlo
                const editTeamBtn = document.getElementById('editTeamBtn');
                if (editTeamBtn) {
                    editTeamBtn.onclick = function() {
                        prepararEdicionEquipo(equipo);
                        teamDetailsModal.hide();
                    };
                }
                  // Si existe el botón de eliminar, configurarlo
                const deleteTeamBtn = document.getElementById('deleteTeamBtn');
                if (deleteTeamBtn) {
                    deleteTeamBtn.onclick = function() {
                        teamDetailsModal.hide();
                        // Limpiar el campo de contraseña antes de mostrar el modal
                        document.getElementById('confirmTeamPassword').value = '';
                        const deleteTeamModal = new bootstrap.Modal(document.getElementById('deleteTeamModal'));
                        deleteTeamModal.show();
                    };
                }
                
                teamDetailsModal.show();
            })
            .catch(error => {
                console.error('Error al cargar detalles del equipo:', error);
                alert('Error al cargar los detalles del equipo: ' + error.message);
            });
    }
    
    // Cargar jugadores disponibles para un equipo
    function cargarJugadoresDisponibles(disciplinaId, equipoId = null) {
        const jugadoresSelect = document.getElementById('teamJugadores');
        if (!jugadoresSelect) return;
        
        jugadoresSelect.innerHTML = '<option disabled>Cargando jugadores...</option>';
        
        let url = `/usuarios/api/jugadores-disponibles/${disciplinaId}/`;
        if (equipoId) {
            url += `?equipo_id=${equipoId}`;
        }
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar jugadores disponibles: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                jugadoresSelect.innerHTML = '';
                
                if (data.length === 0) {
                    jugadoresSelect.innerHTML = '<option disabled>No hay jugadores disponibles</option>';
                    return;
                }
                
                data.forEach(jugador => {
                    const option = document.createElement('option');
                    option.value = jugador.id;
                    // Asegurarse de mostrar algo como nombre
                    const nombreMostrar = jugador.nombre || jugador.email.split('@')[0];
                    option.textContent = `${nombreMostrar} (${jugador.email})`;
                    option.selected = jugador.seleccionado || false;
                    jugadoresSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar jugadores:', error);
                jugadoresSelect.innerHTML = '<option disabled>Error al cargar jugadores</option>';
            });
    }
      // Preparar formulario para editar un equipo
    function prepararEdicionEquipo(equipo) {
        currentEditingTeamId = equipo.id;
        document.getElementById('addEditTeamModalLabel').textContent = 'Editar Equipo';
        document.getElementById('editTeamId').value = equipo.id;
        document.getElementById('teamName').value = equipo.nombre;
        document.getElementById('teamDescripcion').value = equipo.descripcion || '';
        
        // Seleccionar disciplina
        const selectDisciplina = document.getElementById('teamDisciplina');
        for (let i = 0; i < selectDisciplina.options.length; i++) {
            if (selectDisciplina.options[i].value == equipo.disciplina.id) {
                selectDisciplina.selectedIndex = i;
                break;
            }
        }
        
        // Seleccionar carrera
        if (equipo.carrera) {
            const selectCarrera = document.getElementById('teamCarrera');
            for (let i = 0; i < selectCarrera.options.length; i++) {
                if (selectCarrera.options[i].value == equipo.carrera.id) {
                    selectCarrera.selectedIndex = i;
                    break;
                }
            }
        }
        
        // Seleccionar categoría
        if (equipo.categoria) {
            const selectCategoria = document.getElementById('teamCategoria');
            for (let i = 0; i < selectCategoria.options.length; i++) {
                if (selectCategoria.options[i].value == equipo.categoria) {
                    selectCategoria.selectedIndex = i;
                    break;
                }
            }
        }
          // Obtener y cargar jugadores actuales del equipo
        fetch(`/usuarios/api/equipos/${equipo.id}/`)
            .then(response => response.json())
            .then(equipoData => {
                console.log('Datos del equipo cargados:', equipoData);
                
                // Transformar jugadores al formato esperado
                jugadoresSeleccionados = equipoData.jugadores.map(jugador => ({
                    id: jugador.id,
                    nombre: jugador.nombre,
                    email: jugador.email,
                    carrera: jugador.carrera || 'Sin carrera',
                    username: jugador.username || jugador.email.split('@')[0], // Generar username si no existe
                    rol: 'Sin rol', // Valor por defecto
                    disponible: true, // Los jugadores ya en el equipo están "disponibles" para el equipo actual
                    mensaje_estado: 'Disponible'
                }));
                
                console.log('Jugadores seleccionados:', jugadoresSeleccionados);
                
                // Actualizar la lista de jugadores seleccionados
                actualizarJugadoresSeleccionados();
                
                // Actualizar capitanes disponibles
                actualizarCapitanesDisponibles();
                
                // Seleccionar capitán si existe
                if (equipo.capitan) {
                    // Esperar un momento para que se carguen los capitanes disponibles
                    setTimeout(() => {
                        const selectCapitan = document.getElementById('teamCapitan');
                        for (let i = 0; i < selectCapitan.options.length; i++) {
                            if (selectCapitan.options[i].value == equipo.capitan.id) {
                                selectCapitan.selectedIndex = i;
                                break;
                            }
                        }
                    }, 100);
                }
                
                // Cargar usuarios disponibles para mostrar estado de disponibilidad
                buscarUsuarios('', '');
            })
            .catch(error => {
                console.error('Error al cargar datos del equipo:', error);
                alert('Error al cargar los datos del equipo: ' + error.message);
            });
        
        // Mostrar vista previa del logo si existe
        if (equipo.logo) {
            document.getElementById('teamLogoPreview').classList.remove('d-none');
            document.getElementById('logoPreviewImage').src = equipo.logo;
        } else {
            document.getElementById('teamLogoPreview').classList.add('d-none');
        }
        
        const addEditTeamModal = new bootstrap.Modal(document.getElementById('addEditTeamModal'));
        addEditTeamModal.show();
    }    // Guardar un equipo (crear o actualizar)
    function guardarEquipo(event) {
        event.preventDefault();
        
        const equipoId = document.getElementById('editTeamId').value;
        const isEdit = equipoId !== '';
        
        console.log('Guardando equipo - isEdit:', isEdit, 'equipoId:', equipoId);
        console.log('Jugadores seleccionados:', jugadoresSeleccionados);
        
        let url = isEdit ? `/usuarios/api/equipos/${equipoId}/` : '/usuarios/api/equipos/';
        let method = isEdit ? 'PUT' : 'POST';
        
        if (isEdit) {
            // Para PUT, enviar como JSON
            const formData = {
                nombre: document.getElementById('teamName').value,
                descripcion: document.getElementById('teamDescripcion').value,
                disciplina_id: document.getElementById('teamDisciplina').value,
                carrera_id: document.getElementById('teamCarrera').value,
                categoria: document.getElementById('teamCategoria').value,
                capitan_id: document.getElementById('teamCapitan').value || '',
                jugadores: jugadoresSeleccionados.map(jugador => jugador.id)
            };
            
            console.log('Enviando datos para PUT:', formData);
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Respuesta del servidor:', response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(data => {
                        console.error('Error del servidor:', data);
                        throw new Error(data.error || 'Error al actualizar el equipo');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Equipo actualizado exitosamente:', data);
                
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('addEditTeamModal')).hide();
                
                // Mostrar mensaje de éxito
                document.getElementById('teamsMessage').innerHTML = '<div class="alert alert-success">Equipo actualizado correctamente</div>';
                
                // Resetear variables globales
                currentEditingTeamId = null;
                jugadoresSeleccionados = []; // Limpiar jugadores seleccionados
                
                // Recargar datos
                cargarEquipos();
                cargarDisciplinas();
            })
            .catch(error => {
                console.error('Error al actualizar equipo:', error);
                alert('Error: ' + error.message);
            });
        } else {
            // Para POST, usar FormData (para subir archivos)
            const formData = new FormData(document.getElementById('addEditTeamForm'));
            
            // Agregar los jugadores seleccionados al FormData
            formData.delete('jugadores[]');
            jugadoresSeleccionados.forEach(jugador => {
                formData.append('jugadores[]', jugador.id);
                console.log('Agregando jugador:', jugador.id, jugador.nombre);
            });
            
            // Mostrar todos los datos del FormData para depuración
            console.log('Datos del FormData:');
            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => {
                console.log('Respuesta del servidor:', response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(data => {
                        console.error('Error del servidor:', data);
                        throw new Error(data.error || 'Error al crear el equipo');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Equipo creado exitosamente:', data);
                
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('addEditTeamModal')).hide();
                
                // Mostrar mensaje de éxito
                document.getElementById('teamsMessage').innerHTML = '<div class="alert alert-success">Equipo creado correctamente</div>';
                
                // Resetear variables globales
                currentEditingTeamId = null;
                jugadoresSeleccionados = []; // Limpiar jugadores seleccionados
                
                // Recargar datos
                cargarEquipos();
                cargarDisciplinas();
            })
            .catch(error => {
                console.error('Error al crear equipo:', error);
                alert('Error: ' + error.message);
            });
        }
    }
      // Eliminar un equipo
    function eliminarEquipo(event) {
        event.preventDefault();
        
        const password = document.getElementById('confirmTeamPassword').value;
        
        if (!password) {
            alert('Debes ingresar tu contraseña para confirmar');
            return;
        }
        
        fetch(`/usuarios/api/equipos/${currentDeletingTeamId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                admin_password: password
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error al eliminar el equipo');
                });
            }
            return response.json();
        })
        .then(data => {
            // Limpiar el campo de contraseña
            document.getElementById('confirmTeamPassword').value = '';
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('deleteTeamModal')).hide();
            
            // Mostrar mensaje de éxito
            document.getElementById('teamsMessage').innerHTML = '<div class="alert alert-success">Equipo eliminado correctamente</div>';
            
            // Recargar datos
            cargarEquipos();
        })
        .catch(error => {
            console.error('Error al eliminar equipo:', error);            // Limpiar el campo de contraseña incluso en caso de error
            document.getElementById('confirmTeamPassword').value = '';
            alert('Error: ' + error.message);
        });
    }

    // Mostrar modal para seleccionar disciplina a eliminar
    function mostrarModalEliminarDisciplina() {
        // Cargar disciplinas en el select
        fetch('/usuarios/api/disciplinas/')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('disciplinaAEliminar');
                select.innerHTML = '<option value="" disabled selected>Seleccionar disciplina...</option>';
                
                data.forEach(disciplina => {
                    const option = document.createElement('option');
                    option.value = disciplina.id;
                    option.textContent = disciplina.nombre;
                    select.appendChild(option);
                });
                
                // Resetear modal a paso inicial
                document.getElementById('selectDisciplinaStep').style.display = 'block';
                document.getElementById('confirmDisciplinaStep').style.display = 'none';
                document.getElementById('nextStepBtn').style.display = 'inline-block';
                document.getElementById('confirmDeleteDisciplinaBtn').style.display = 'none';
                document.getElementById('confirmDisciplinaPassword').value = '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('deleteDisciplinaModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error al cargar disciplinas:', error);
                alert('Error al cargar las disciplinas');
            });
    }

    // Continuar al paso de confirmación
    function continuarEliminacionDisciplina() {
        const disciplinaId = document.getElementById('disciplinaAEliminar').value;
        const disciplinaNombre = document.getElementById('disciplinaAEliminar').options[document.getElementById('disciplinaAEliminar').selectedIndex].text;
        
        if (!disciplinaId) {
            alert('Debes seleccionar una disciplina');
            return;
        }
        
        // Guardar ID de disciplina a eliminar
        currentDeletingDisciplinaId = disciplinaId;
        
        // Actualizar nombre en el texto de confirmación
        document.getElementById('deleteDisciplinaName').textContent = disciplinaNombre;
        
        // Cambiar al paso de confirmación
        document.getElementById('selectDisciplinaStep').style.display = 'none';
        document.getElementById('confirmDisciplinaStep').style.display = 'block';
        document.getElementById('nextStepBtn').style.display = 'none';
        document.getElementById('confirmDeleteDisciplinaBtn').style.display = 'inline-block';
    }

    // Eliminar disciplina
    function eliminarDisciplina(event) {
        event.preventDefault();
        
        const password = document.getElementById('confirmDisciplinaPassword').value;
        
        if (!password) {
            alert('Debes ingresar tu contraseña para confirmar');
            return;
        }
        
        if (!currentDeletingDisciplinaId) {
            alert('Error: No se ha seleccionado ninguna disciplina');
            return;
        }
        
        fetch(`/usuarios/api/disciplinas/${currentDeletingDisciplinaId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                admin_password: password
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error al eliminar la disciplina');
                });
            }
            return response.json();
        })
        .then(data => {
            // Limpiar campos
            document.getElementById('confirmDisciplinaPassword').value = '';
            currentDeletingDisciplinaId = null;
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('deleteDisciplinaModal')).hide();
            
            // Mostrar mensaje de éxito
            document.getElementById('teamsMessage').innerHTML = '<div class="alert alert-success">Disciplina eliminada correctamente</div>';
            
            // Recargar página para actualizar las pestañas
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        })
        .catch(error => {
            console.error('Error al eliminar disciplina:', error);
            // Limpiar el campo de contraseña incluso en caso de error
            document.getElementById('confirmDisciplinaPassword').value = '';
            alert('Error: ' + error.message);
        });
    }

    // Preparar formulario para crear una nueva disciplina
    function prepararNuevaDisciplina() {
        document.getElementById('addEditDisciplinaModalLabel').textContent = 'Nueva Disciplina';
        document.getElementById('editDisciplinaId').value = '';
        document.getElementById('disciplinaNombre').value = '';
        document.getElementById('disciplinaDescripcion').value = '';
        document.getElementById('disciplinaImagenPreview').classList.add('d-none');
        
        const addEditDisciplinaModal = new bootstrap.Modal(document.getElementById('addEditDisciplinaModal'));
        addEditDisciplinaModal.show();
    }
    
    // Guardar una disciplina (crear o actualizar)
    function guardarDisciplina(event) {
        event.preventDefault();
        
        const formData = new FormData(document.getElementById('addEditDisciplinaForm'));
        const disciplinaId = document.getElementById('editDisciplinaId').value;
        const isEdit = disciplinaId !== '';
        
        let url = isEdit ? `/usuarios/api/disciplinas/${disciplinaId}/` : '/usuarios/api/disciplinas/';
        let method = isEdit ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error al guardar la disciplina');
                });
            }
            return response.json();
        })
        .then(data => {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('addEditDisciplinaModal')).hide();
            
            // Mostrar mensaje de éxito
            const mensaje = isEdit ? 'Disciplina actualizada correctamente' : 'Disciplina creada correctamente';
            document.getElementById('teamsMessage').innerHTML = `<div class="alert alert-success">${mensaje}</div>`;
            
            // Recargar datos
            cargarDisciplinas();
            cargarEquipos();
        })
        .catch(error => {
            console.error('Error al guardar disciplina:', error);
            alert('Error: ' + error.message);
        });
    }    // Preparar formulario para crear un nuevo equipo
    function prepararNuevoEquipo() {
        currentEditingTeamId = null;
        document.getElementById('addEditTeamModalLabel').textContent = 'Nuevo Equipo';
        document.getElementById('editTeamId').value = '';
        document.getElementById('addEditTeamForm').reset();
        document.getElementById('teamLogoPreview').classList.add('d-none');
        
        // Limpiar jugadores seleccionados
        jugadoresSeleccionados = [];
        actualizarJugadoresSeleccionados();
        document.getElementById('jugadoresResultados').innerHTML = '';
        document.getElementById('jugadoresBuscador').value = '';
        
        // Cargar datos necesarios
        cargarCarreras();
        cargarDisciplinas();
        
        // Cargar usuarios iniciales para mostrar
        buscarUsuarios('', '');
        
        const addEditTeamModal = new bootstrap.Modal(document.getElementById('addEditTeamModal'));
        addEditTeamModal.show();
    }
    
    // Variables para el manejo de jugadores
    let jugadoresSeleccionados = [];
    let busquedaTimeout;    // Buscar usuarios/jugadores
    function buscarUsuarios(query = '', carreraId = '') {
        clearTimeout(busquedaTimeout);
        
        // Mostrar indicador de carga
        document.getElementById('jugadoresResultados').innerHTML = 
            '<div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div> Buscando usuarios...</div>';
        
        busquedaTimeout = setTimeout(() => {
            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (carreraId) params.append('carrera_id', carreraId);
            
            // Agregar disciplina_id para verificar disponibilidad
            const disciplinaId = document.getElementById('teamDisciplina')?.value;
            if (disciplinaId) params.append('disciplina_id', disciplinaId);
            
            fetch(`/usuarios/api/buscar-usuarios/?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al buscar usuarios: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    mostrarResultadosBusqueda(data);
                })
                .catch(error => {
                    console.error('Error al buscar usuarios:', error);
                    document.getElementById('jugadoresResultados').innerHTML = 
                        '<div class="text-danger p-2">Error al buscar usuarios</div>';
                });
        }, 300);
    }
      // Mostrar resultados de búsqueda de usuarios
    function mostrarResultadosBusqueda(usuarios) {
        const resultadosDiv = document.getElementById('jugadoresResultados');
        if (usuarios.length === 0) {
            resultadosDiv.innerHTML = '<div class="text-muted">No se encontraron usuarios</div>';
            return;
        }
        
        let html = '';
        usuarios.forEach(usuario => {
            const isSelected = jugadoresSeleccionados.some(j => j.id === usuario.id);
            const isDisabled = !usuario.disponible && !isSelected; // Solo deshabilitar si no está disponible Y no está ya seleccionado
            
            html += `
                <div class="usuario-resultado p-2 border-bottom ${isSelected ? 'bg-success bg-opacity-25' : ''} ${isDisabled ? 'opacity-50' : ''}" 
                     data-usuario-id="${usuario.id}" style="cursor: ${isDisabled ? 'not-allowed' : 'pointer'};">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${usuario.nombre}</strong>
                            <small class="text-muted d-block">${usuario.email}</small>
                            <small class="text-info d-block">${usuario.carrera}</small>
                            <div class="d-flex gap-2 align-items-center mt-1">
                                ${usuario.rol ? `<small class="badge bg-secondary">${usuario.rol}</small>` : ''}
                                ${!usuario.disponible ? 
                                    `<small class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle"></i> ${usuario.mensaje_estado}</small>` : 
                                    `<small class="badge bg-success"><i class="fas fa-check"></i> ${usuario.mensaje_estado}</small>`
                                }
                            </div>
                        </div>
                        <div>
                            ${isSelected ? 
                                '<i class="fas fa-check-circle text-success"></i>' : 
                                (isDisabled ? '<i class="fas fa-ban text-warning"></i>' : '<i class="fas fa-plus-circle text-primary"></i>')
                            }
                        </div>
                    </div>
                </div>
            `;
        });
        
        resultadosDiv.innerHTML = html;
        
        // Agregar event listeners para seleccionar/deseleccionar usuarios
        document.querySelectorAll('.usuario-resultado').forEach(elemento => {
            elemento.addEventListener('click', function() {
                const usuarioId = parseInt(this.dataset.usuarioId);
                const usuario = usuarios.find(u => u.id === usuarioId);
                
                // Prevenir seleccionar usuarios no disponibles (a menos que ya estén seleccionados)
                const isSelected = jugadoresSeleccionados.some(j => j.id === usuarioId);
                if (!usuario.disponible && !isSelected) {
                    return; // No permitir seleccionar
                }
                
                if (isSelected) {
                    // Deseleccionar
                    jugadoresSeleccionados = jugadoresSeleccionados.filter(j => j.id !== usuarioId);                } else {
                    // Seleccionar
                    jugadoresSeleccionados.push(usuario);
                }
                
                actualizarJugadoresSeleccionados();
                mostrarResultadosBusqueda(usuarios); // Actualizar la vista
            });
        });
    }

    // Actualizar la lista de jugadores seleccionados
    function actualizarJugadoresSeleccionados() {
        const listaDiv = document.getElementById('listaJugadoresSeleccionados');
        
        if (jugadoresSeleccionados.length === 0) {
            listaDiv.innerHTML = '<div class="text-muted">No hay jugadores seleccionados</div>';
        } else {
            let html = '';
            jugadoresSeleccionados.forEach(jugador => {
                html += `
                    <div class="jugador-seleccionado badge bg-primary me-2 mb-2 p-2 d-inline-flex align-items-center">
                        ${jugador.nombre}
                        <button type="button" class="btn-close btn-close-white ms-2" 
                                onclick="removerJugadorSeleccionado(${jugador.id})" 
                                style="font-size: 0.7em;"></button>
                    </div>
                `;
            });
            listaDiv.innerHTML = html;
        }
        
        // Actualizar capitanes disponibles
        actualizarCapitanesDisponibles();
    }
      // Remover jugador seleccionado
    function removerJugadorSeleccionado(usuarioId) {
        jugadoresSeleccionados = jugadoresSeleccionados.filter(j => j.id !== usuarioId);
        actualizarJugadoresSeleccionados();
        
        // Actualizar la vista de resultados si existe
        const query = document.getElementById('jugadoresBuscador').value;
        // NO pasar carrera automáticamente
        if (query) {
            buscarUsuarios(query, '');
        }
    }
      // Actualizar capitanes disponibles basado en los jugadores seleccionados
    function actualizarCapitanesDisponibles() {
        const selectCapitan = document.getElementById('teamCapitan');
        selectCapitan.innerHTML = '<option value="">Seleccionar capitán</option>';
        
        jugadoresSeleccionados.forEach(jugador => {
            const option = document.createElement('option');
            option.value = jugador.id;
            option.textContent = jugador.nombre;
            selectCapitan.appendChild(option);
        });
    }
    
    // Event listeners
    
    // Botón para agregar nuevo equipo
    document.getElementById('addTeamBtn')?.addEventListener('click', prepararNuevoEquipo);
      // Botón para agregar nueva disciplina
    document.getElementById('addDisciplinaBtn')?.addEventListener('click', prepararNuevaDisciplina);
    
    // Botón para eliminar disciplina
    document.getElementById('deleteDisciplinaBtn')?.addEventListener('click', mostrarModalEliminarDisciplina);
    
    // Botón para continuar con eliminación de disciplina
    document.getElementById('nextStepBtn')?.addEventListener('click', continuarEliminacionDisciplina);
    
    // Botón para confirmar eliminación de disciplina
    document.getElementById('confirmDeleteDisciplinaBtn')?.addEventListener('click', eliminarDisciplina);
    
    // Botón para guardar equipo
    document.getElementById('saveTeamBtn')?.addEventListener('click', guardarEquipo);
    
    // Botón para guardar disciplina
    document.getElementById('saveDisciplinaBtn')?.addEventListener('click', guardarDisciplina);
      // Buscador de jugadores
    document.getElementById('jugadoresBuscador')?.addEventListener('input', function() {
        const query = this.value;
        // NO pasar carrera automáticamente - mostrar todos los usuarios
        buscarUsuarios(query, '');
    });
      // Botón de búsqueda de jugadores
    document.getElementById('buscarJugadoresBtn')?.addEventListener('click', function() {
        const query = document.getElementById('jugadoresBuscador').value;
        // NO pasar carrera automáticamente - solo si el usuario quiere filtrar por carrera específicamente
        buscarUsuarios(query, '');
    });// Cambio en carrera - NO filtrar automáticamente por carrera
    document.getElementById('teamCarrera')?.addEventListener('change', function() {
        // NO hacer nada automáticamente cuando cambia la carrera
        // Los usuarios ya cargados se mantienen visibles
        // El filtro por carrera solo se aplicará si el usuario hace una búsqueda explícita
        console.log('Carrera seleccionada:', this.value);
    });
    
    // Cambio en disciplina para actualizar disponibilidad de jugadores
    document.getElementById('teamDisciplina')?.addEventListener('change', function() {
        const query = document.getElementById('jugadoresBuscador')?.value || '';
        const carreraId = document.getElementById('teamCarrera')?.value || '';
        
        // Actualizar la búsqueda para mostrar disponibilidad en la nueva disciplina
        if (query || carreraId || document.getElementById('jugadoresResultados').innerHTML.trim()) {
            buscarUsuarios(query, carreraId);
        }
    });
    
    // Event listener para cuando se abre el modal de equipo
    document.getElementById('addEditTeamModal')?.addEventListener('shown.bs.modal', function() {
        // Si no hay usuarios cargados, cargar algunos iniciales
        const resultadosDiv = document.getElementById('jugadoresResultados');
        if (!resultadosDiv.innerHTML.trim()) {
            buscarUsuarios('', '');
        }
    });
      // Cambio en jugadores seleccionados para actualizar capitanes
    document.addEventListener('jugadoresActualizados', actualizarCapitanesDisponibles);

    // Event listener para el botón de confirmación de eliminación de equipo
    document.getElementById('confirmDeleteTeamBtn')?.addEventListener('click', eliminarEquipo);

    // Cargar todos los equipos
    cargarDisciplinas();
    cargarCarreras();
    cargarEquipos();
});
</script>
{% endblock %}

